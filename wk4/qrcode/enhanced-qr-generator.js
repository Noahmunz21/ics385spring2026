/*
 * Author: Noah Munz
 * Date: February 6, 2026
 * 
 * QR Code Generator - Enhanced Version
 * 
 * Overview:
 * This application generates QR codes from user-provided URLs with enhanced
 * security features, validation, and customization options.
 * 
 * Key Highlights:
 * - URL validation to ensure proper format
 * - Security checks for malicious URLs
 * - Custom QR code styling options (size, error correction)
 * - User-friendly prompts with color coding
 * - Comprehensive error handling
 * - History tracking of generated QR codes
 * 
 * Dependencies:
 * - inquirer: For interactive command-line prompts
 * - qr-image: For QR code generation
 * - fs: Node.js native file system module
 * 
 * AI Generation Notes:
 * - Core structure based on original solution.js
 * - Enhanced features generated with assistance from Claude (Anthropic)
 * - URL validation logic: AI-assisted
 * - Security checks: AI-assisted
 * - Styling options: AI-assisted
 */

import inquirer from "inquirer";
import qr from "qr-image";
import fs from "fs";

// ============================================
// UTILITY FUNCTIONS
// ============================================

/**
 * Validates if the provided string is a proper URL
 * AI-Generated: Claude (Anthropic)
 * 
 * @param {string} url - The URL to validate
 * @returns {boolean} - True if valid, false otherwise
 */
function isValidURL(url) {
  try {
    const urlObj = new URL(url);
    // Check for http or https protocol
    return urlObj.protocol === "http:" || urlObj.protocol === "https:";
  } catch (error) {
    return false;
  }
}

/**
 * Basic security check for suspicious URLs
 * AI-Generated: Claude (Anthropic)
 * 
 * @param {string} url - The URL to check
 * @returns {object} - {safe: boolean, warnings: string[]}
 */
function checkURLSecurity(url) {
  const warnings = [];
  const suspiciousPatterns = [
    { pattern: /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/, message: "URL contains IP address" },
    { pattern: /@/, message: "URL contains @ symbol (possible phishing)" },
    { pattern: /\-\-/, message: "URL contains double hyphens" },
  ];

  // Check for suspicious patterns
  suspiciousPatterns.forEach(({ pattern, message }) => {
    if (pattern.test(url)) {
      warnings.push(message);
    }
  });

  // Check URL length (very long URLs can be suspicious)
  if (url.length > 200) {
    warnings.push("URL is unusually long");
  }

  return {
    safe: warnings.length === 0,
    warnings: warnings,
  };
}

/**
 * Appends entry to QR code generation history
 * AI-Generated: Claude (Anthropic)
 * 
 * @param {string} url - The URL that was encoded
 * @param {string} filename - The output filename
 */
function logToHistory(url, filename) {
  const timestamp = new Date().toISOString();
  const logEntry = `${timestamp} | ${url} | ${filename}\n`;

  fs.appendFile("qr_history.txt", logEntry, (err) => {
    if (err) {
      console.error("Warning: Could not write to history file");
    }
  });
}

// ============================================
// MAIN APPLICATION LOGIC
// ============================================

/**
 * Main function to run the QR code generator
 * Original structure from solution.js
 * Enhanced prompts and validation: AI-Generated by Claude (Anthropic)
 */
async function generateQRCode() {
  console.log("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  console.log("‚ïë   Enhanced QR Code Generator v2.0     ‚ïë");
  console.log("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
  console.log("‚ïë");
  console.log("‚ïë  Create secure QR codes with validation");
  console.log("‚ïë");
  console.log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");

  try {
    // Prompt user for URL
    const urlAnswer = await inquirer.prompt([
      {
        type: "input",
        name: "URL",
        message: "Enter the URL you want to encode:",
        // AI-Generated validation by Claude (Anthropic)
        validate: function (input) {
          if (!input || input.trim() === "") {
            return "Please enter a URL";
          }
          if (!isValidURL(input)) {
            return "Please enter a valid URL (must start with http:// or https://)";
          }
          return true;
        },
      },
    ]);

    const url = urlAnswer.URL;

    // Perform security check
    const securityCheck = checkURLSecurity(url);
    if (!securityCheck.safe) {
      console.log("\n‚ö†Ô∏è  Security Warnings Detected:");
      securityCheck.warnings.forEach((warning) => {
        console.log(`   - ${warning}`);
      });

      const proceedAnswer = await inquirer.prompt([
        {
          type: "confirm",
          name: "proceed",
          message: "Do you want to proceed anyway?",
          default: false,
        },
      ]);

      if (!proceedAnswer.proceed) {
        console.log("\n‚ùå QR code generation cancelled.\n");
        return;
      }
    }

    // Prompt for QR code customization options
    // AI-Generated by Claude (Anthropic)
    const options = await inquirer.prompt([
      {
        type: "list",
        name: "errorCorrection",
        message: "Select error correction level:",
        choices: [
          { name: "Low (7% recovery)", value: "L" },
          { name: "Medium (15% recovery) - Recommended", value: "M" },
          { name: "Quartile (25% recovery)", value: "Q" },
          { name: "High (30% recovery)", value: "H" },
        ],
        default: 1, // Medium
      },
      {
        type: "list",
        name: "size",
        message: "Select QR code size:",
        choices: [
          { name: "Small (5)", value: 5 },
          { name: "Medium (10) - Recommended", value: 10 },
          { name: "Large (15)", value: 15 },
          { name: "Extra Large (20)", value: 20 },
        ],
        default: 1, // Medium
      },
      {
        type: "input",
        name: "filename",
        message: "Enter filename for QR code (without extension):",
        default: "qr_img",
        validate: function (input) {
          if (!input || input.trim() === "") {
            return "Please enter a filename";
          }
          // Check for invalid filename characters
          if (/[<>:"/\\|?*]/.test(input)) {
            return "Filename contains invalid characters";
          }
          return true;
        },
      },
    ]);

    const filename = `${options.filename}.png`;

    // Generate QR code with custom options
    // AI-Generated options configuration by Claude (Anthropic)
    const qrOptions = {
      ec_level: options.errorCorrection,
      size: options.size,
      margin: 2,
    };

    console.log("\nüîÑ Generating QR code...");

    const qr_svg = qr.image(url, qrOptions);
    qr_svg.pipe(fs.createWriteStream(filename));

    // Save URL to text file
    // Original code from solution.js
    fs.writeFile("URL.txt", url, (err) => {
      if (err) {
        console.error("‚ùå Error saving URL to file:", err.message);
      } else {
        console.log("‚úÖ URL saved to URL.txt");
      }
    });

    // Log to history
    // AI-Generated by Claude (Anthropic)
    logToHistory(url, filename);

    // Wait a moment for file write to complete
    setTimeout(() => {
      console.log(`‚úÖ QR code generated successfully: ${filename}`);
      console.log(`üìä Error Correction: ${options.errorCorrection} | Size: ${options.size}`);
      console.log(`üìù History updated in qr_history.txt\n`);
    }, 500);

  } catch (error) {
    // Enhanced error handling
    // AI-Generated by Claude (Anthropic)
    if (error.isTtyError) {
      console.error("‚ùå Error: Prompt couldn't be rendered in the current environment");
    } else {
      console.error("‚ùå An unexpected error occurred:", error.message);
    }
  }
}

// ============================================
// APPLICATION ENTRY POINT
// ============================================

// Run the application
// Original structure from solution.js
generateQRCode();
